# ==============================================================================
# ConvertX-CN Docker Compose å®Œæ•´éƒ¨ç½²é…ç½®
# ==============================================================================
#
# ğŸ¯ è¨­è¨ˆç›®æ¨™ï¼š
#    - ä¸€éµéƒ¨ç½²ï¼Œé›¶é…ç½®å³å¯é‹è¡Œ
#    - JWT èªè­‰çµ±ä¸€ï¼ˆWeb UI èˆ‡ API å…±ç”¨ JWT_SECRETï¼‰
#    - æ”¯æ´ GPU åŠ é€Ÿï¼ˆNVIDIAï¼‰
#    - MinerU å¼·åˆ¶ CPU-onlyï¼ˆé¿å… GPU è¨˜æ†¶é«”ä¸è¶³ï¼‰
#    - 24 å°æ™‚è‡ªå‹•æ¸…ç†ï¼ˆé˜²æ­¢ç£ç¢Ÿç©ºé–“è€—ç›¡ï¼‰
#
# ğŸš€ å¿«é€Ÿé–‹å§‹ï¼š
#
#    # 1. å»ºç«‹è³‡æ–™ç›®éŒ„
#    mkdir -p data
#
#    # 2. ç”¢ç”Ÿ JWT å¯†é‘°ï¼ˆä¸€æ¬¡æ€§ï¼‰
#    echo "JWT_SECRET=$(openssl rand -hex 32)" > .env
#
#    # 3. å•Ÿå‹•æœå‹™
#    docker compose up -d
#
# ğŸ“– Profile èªªæ˜ï¼š
#
#    # åªå•Ÿå‹• Web UIï¼ˆé è¨­ï¼‰
#    docker compose up -d
#
#    # Web UI + API Server
#    docker compose --profile api up -d
#
#    # Web UI + GPU åŠ é€Ÿ
#    docker compose --profile gpu up -d
#
#    # Web UI + MinerUï¼ˆCPU-onlyï¼‰
#    docker compose --profile mineru up -d
#
#    # Web UI + API + GPU + MinerU + è‡ªå‹•æ¸…ç†ï¼ˆå®Œæ•´ç‰ˆï¼‰
#    docker compose --profile api --profile gpu --profile mineru --profile cleanup up -d
#
# ==============================================================================

services:
  # ===========================================================================
  # ConvertX Web UI - ä¸»æœå‹™
  # ===========================================================================
  convertx:
    image: convertx/convertx-cn:latest
    container_name: convertx-cn
    restart: unless-stopped

    ports:
      - "3000:3000"

    volumes:
      - ./data:/app/data

    environment:
      # æ™‚å€
      - TZ=Asia/Taipei

      # ---------------------------------------------------------------------
      # ğŸ” JWT çµ±ä¸€èªè­‰ï¼ˆé—œéµè¨­å®šï¼‰
      # ---------------------------------------------------------------------
      # Web UI å’Œ API Server å…±ç”¨åŒä¸€å€‹ JWT_SECRET
      # é€™æ¨£ Web UI ç”¢ç”Ÿçš„ Token å¯ä»¥ç›´æ¥ç”¨æ–¼ API èªè­‰
      #
      # âš ï¸ å¿…é ˆåœ¨ .env æª”æ¡ˆä¸­è¨­å®šï¼Œæˆ–åœ¨æ­¤è™•ä¿®æ”¹
      - JWT_SECRET=${JWT_SECRET:-è«‹è¨­å®šä½ çš„JWTå¯†é‘°-è‡³å°‘32å­—å…ƒ}

      # å¸³è™Ÿè¨­å®š
      - ACCOUNT_REGISTRATION=true
      - HTTP_ALLOWED=true
      - TRUST_PROXY=false
      - ALLOW_UNAUTHENTICATED=false

      # è‡ªå‹•æ¸…ç†ï¼ˆå°æ™‚ï¼Œ0=åœç”¨ï¼‰
      - AUTO_DELETE_EVERY_N_HOURS=24

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    networks:
      - convertx-network

  # ===========================================================================
  # ConvertX RAS API Serverï¼ˆé¸ç”¨ï¼‰
  # ===========================================================================
  # å•Ÿç”¨æ–¹å¼ï¼šdocker compose --profile api up -d
  # ===========================================================================
  convertx-api:
    profiles:
      - api

    build:
      context: ./api-server
      dockerfile: Dockerfile

    container_name: convertx-api
    restart: unless-stopped

    ports:
      - "7890:7890"

    volumes:
      - ./data:/app/data

    environment:
      - TZ=Asia/Taipei
      - RAS_API_HOST=0.0.0.0
      - RAS_API_PORT=7890

      # ---------------------------------------------------------------------
      # ğŸ” JWT çµ±ä¸€èªè­‰
      # ---------------------------------------------------------------------
      # èˆ‡ Web UI ä½¿ç”¨ç›¸åŒçš„ JWT_SECRET
      # é€™æ¨£ Web UI ç™»å…¥ç”¢ç”Ÿçš„ Token å¯ä»¥ç›´æ¥ç”¨æ–¼ API è«‹æ±‚
      - JWT_SECRET=${JWT_SECRET:-è«‹è¨­å®šä½ çš„JWTå¯†é‘°-è‡³å°‘32å­—å…ƒ}

      # æª”æ¡ˆè·¯å¾‘ï¼ˆèˆ‡ Web UI å…±ç”¨ data ç›®éŒ„ï¼‰
      - UPLOAD_DIR=/app/data/api-uploads
      - OUTPUT_DIR=/app/data/api-output

      # å…¶ä»–è¨­å®š
      - MAX_FILE_SIZE=524288000
      - RUST_LOG=convertx_ras_api=info,tower_http=info
      - ENABLE_SWAGGER=true

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7890/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    depends_on:
      - convertx

    networks:
      - convertx-network

  # ===========================================================================
  # ConvertX GPU åŠ é€Ÿç‰ˆï¼ˆé¸ç”¨ï¼‰
  # ===========================================================================
  # å•Ÿç”¨æ–¹å¼ï¼šdocker compose --profile gpu up -d
  #
  # âš ï¸ éœ€æ±‚ï¼š
  #    1. NVIDIA é©…å‹•ç¨‹å¼
  #    2. nvidia-container-toolkit
  #    3. è¶³å¤ çš„ GPU è¨˜æ†¶é«”ï¼ˆå»ºè­° 8GB+ï¼‰
  # ===========================================================================
  convertx-gpu:
    profiles:
      - gpu

    image: convertx/convertx-cn:gpu
    container_name: convertx-cn-gpu
    restart: unless-stopped

    ports:
      - "3000:3000"

    volumes:
      - ./data:/app/data

    environment:
      - TZ=Asia/Taipei
      - JWT_SECRET=${JWT_SECRET:-è«‹è¨­å®šä½ çš„JWTå¯†é‘°-è‡³å°‘32å­—å…ƒ}
      - ACCOUNT_REGISTRATION=true
      - HTTP_ALLOWED=true
      - TRUST_PROXY=false
      - ALLOW_UNAUTHENTICATED=false
      - AUTO_DELETE_EVERY_N_HOURS=24

      # GPU åŠ é€Ÿè¨­å®š
      - NVIDIA_VISIBLE_DEVICES=all
      - CUDA_VISIBLE_DEVICES=0

    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    networks:
      - convertx-network

  # ===========================================================================
  # MinerU PDF è™•ç†å™¨ï¼ˆé¸ç”¨ï¼Œå¼·åˆ¶ CPU-onlyï¼‰
  # ===========================================================================
  # å•Ÿç”¨æ–¹å¼ï¼šdocker compose --profile mineru up -d
  #
  # ğŸ“ èªªæ˜ï¼š
  #    MinerU æ˜¯å°ˆæ¥­çš„ PDF æ–‡å­—æ“·å–å·¥å…·
  #    å¼·åˆ¶ä½¿ç”¨ CPU ä»¥é¿å…èˆ‡å…¶ä»– GPU ä»»å‹™ç«¶çˆ­è¨˜æ†¶é«”
  # ===========================================================================
  mineru:
    profiles:
      - mineru

    image: opendatalab/mineru:latest
    container_name: convertx-mineru
    restart: unless-stopped

    volumes:
      - ./data/mineru-input:/app/input
      - ./data/mineru-output:/app/output
      - ./models/mineru:/app/models

    environment:
      - TZ=Asia/Taipei

      # ---------------------------------------------------------------------
      # ğŸš« å¼·åˆ¶ CPU-only
      # ---------------------------------------------------------------------
      # è¨­å®š CUDA_VISIBLE_DEVICES="" ç¦ç”¨ GPU
      # é€™å¯é˜²æ­¢ MinerU ä½”ç”¨å¤§é‡ GPU è¨˜æ†¶é«”
      - CUDA_VISIBLE_DEVICES=

      # å¼·åˆ¶ä½¿ç”¨ CPU
      - DEVICE=cpu
      - MINERU_DEVICE=cpu

    # ä¸åˆ†é… GPU è³‡æº
    # deploy:
    #   resources:
    #     reservations:
    #       devices: []

    healthcheck:
      test: ["CMD", "python", "-c", "import magic_pdf; print('ok')"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 120s

    networks:
      - convertx-network

  # ===========================================================================
  # 24 å°æ™‚è‡ªå‹•æ¸…ç†æ’ç¨‹ï¼ˆé¸ç”¨ï¼‰
  # ===========================================================================
  # å•Ÿç”¨æ–¹å¼ï¼šdocker compose --profile cleanup up -d
  #
  # ğŸ“ èªªæ˜ï¼š
  #    ä½¿ç”¨ ofelia ä½œç‚ºè¼•é‡ç´š cron æ’ç¨‹å™¨
  #    æ¯ 24 å°æ™‚åŸ·è¡Œä¸€æ¬¡æ¸…ç†ä»»å‹™
  # ===========================================================================
  cleanup-scheduler:
    profiles:
      - cleanup

    image: mcuadros/ofelia:latest
    container_name: convertx-cleanup
    restart: unless-stopped

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

    labels:
      # ---------------------------------------------------------------------
      # 24 å°æ™‚æ¸…ç†æ’ç¨‹
      # ---------------------------------------------------------------------
      # æ¯å¤©å‡Œæ™¨ 3:00 åŸ·è¡Œæ¸…ç†
      ofelia.job-exec.cleanup-uploads.schedule: "0 3 * * *"
      ofelia.job-exec.cleanup-uploads.container: "convertx-cn"
      ofelia.job-exec.cleanup-uploads.command: >
        sh -c "find /app/data/uploads -type f -mtime +1 -delete &&
               find /app/data/output -type f -mtime +1 -delete &&
               find /app/data/uploads -type d -empty -delete &&
               find /app/data/output -type d -empty -delete &&
               echo 'Cleanup completed at $(date)'"

      # API ç›®éŒ„æ¸…ç†ï¼ˆå¦‚æœå•Ÿç”¨ APIï¼‰
      ofelia.job-exec.cleanup-api.schedule: "0 4 * * *"
      ofelia.job-exec.cleanup-api.container: "convertx-cn"
      ofelia.job-exec.cleanup-api.command: >
        sh -c "find /app/data/api-uploads -type f -mtime +1 -delete 2>/dev/null;
               find /app/data/api-output -type f -mtime +1 -delete 2>/dev/null;
               find /app/data/api-uploads -type d -empty -delete 2>/dev/null;
               find /app/data/api-output -type d -empty -delete 2>/dev/null;
               echo 'API cleanup completed at $(date)'"

    depends_on:
      - convertx

    networks:
      - convertx-network

  # ===========================================================================
  # ç¨ç«‹æ¸…ç†å®¹å™¨ï¼ˆå‚™é¸æ–¹æ¡ˆï¼‰
  # ===========================================================================
  # å¦‚æœä¸æƒ³ä½¿ç”¨ ofeliaï¼Œå¯ä»¥ä½¿ç”¨é€™å€‹ç°¡å–®çš„ alpine cron å®¹å™¨
  # ===========================================================================
  # cleanup-cron:
  #   profiles:
  #     - cleanup-simple
  #
  #   image: alpine:latest
  #   container_name: convertx-cleanup-cron
  #   restart: unless-stopped
  #
  #   volumes:
  #     - ./data:/app/data
  #
  #   command: |
  #     sh -c '
  #       echo "0 3 * * * find /app/data/uploads -type f -mtime +1 -delete && \
  #              find /app/data/output -type f -mtime +1 -delete && \
  #              find /app/data -type d -empty -delete" | crontab -
  #       crond -f -l 2
  #     '
  #
  #   networks:
  #     - convertx-network

# =============================================================================
# Networks
# =============================================================================
networks:
  convertx-network:
    driver: bridge

# =============================================================================
# ç’°å¢ƒè®Šæ•¸ç¯„ä¾‹ï¼ˆ.env æª”æ¡ˆï¼‰
# =============================================================================
#
# å»ºç«‹ .env æª”æ¡ˆï¼š
#
#   # ç”¢ç”Ÿéš¨æ©Ÿ JWT å¯†é‘°
#   JWT_SECRET=$(openssl rand -hex 32)
#
#   # æˆ–ä½¿ç”¨å›ºå®šå€¼ï¼ˆæ­£å¼ç’°å¢ƒè«‹æ›´æ›ï¼‰
#   JWT_SECRET=your-super-secret-jwt-key-at-least-32-characters-long
#
# =============================================================================
