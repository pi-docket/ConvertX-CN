name: Docker Pulls History

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  track:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout（⚠️ 不要保留 checkout 的 credentials）
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: main
          persist-credentials: false # ⭐⭐⭐ 關鍵
          fetch-depth: 0

      # 2️⃣ 抓 Docker Hub 下載數
      - name: Fetch Docker Hub pull count
        run: |
          set -e
          mkdir -p metrics

          if [ ! -f metrics/docker-pulls.csv ]; then
            echo "date,pulls" > metrics/docker-pulls.csv
          fi

          DATE=$(date -u +"%Y-%m-%d")
          PULLS=$(curl -s https://hub.docker.com/v2/repositories/convertx/convertx-cn/ | jq '.pull_count')

          if ! grep -q "^$DATE," metrics/docker-pulls.csv; then
            echo "$DATE,$PULLS" >> metrics/docker-pulls.csv
          fi

      # 3️⃣ 產生 SVG
      - name: Generate SVG chart (star-history style)
        run: |
          node <<'EOF'
          const fs = require('fs');
          const csvPath = 'metrics/docker-pulls.csv';
          const outPath = 'metrics/docker-pulls-history.svg';

          const rows = fs.readFileSync(csvPath, 'utf8')
            .trim().split('\n').slice(1)
            .map(r => {
              const [d, p] = r.split(',');
              return { date: d, pulls: Number(p) };
            });

          const dates = rows.map(r => r.date);
          const pulls = rows.map(r => r.pulls);

          const max = Math.max(...pulls);
          const w = 800, h = 400;
          const padX = 60, padY = 60;
          const plotW = w - padX * 2;
          const plotH = h - padY * 2;

          const points = pulls.map((v, i) => {
            const x = padX + (i / (pulls.length - 1)) * plotW;
            const y = h - padY - (v / max) * plotH;
            return `${x},${y}`;
          }).join(' ');

          const svg = `
          <svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}"
               xmlns="http://www.w3.org/2000/svg">
            <rect width="100%" height="100%" fill="#fff"/>
            <text x="${w/2}" y="28" text-anchor="middle"
                  font-size="18" font-weight="600">
              Docker Pull History · convertx/convertx-cn
            </text>
            <polyline fill="none" stroke="#2f81f7"
                      stroke-width="2" points="${points}" />
          </svg>`;
          fs.writeFileSync(outPath, svg.trim());
          EOF

      # 4️⃣ 檢查是否有變更
      - name: Check if there are changes
        id: changes
        run: |
          if git status --porcelain | grep .; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      # 5️⃣ 建立 PR（⭐ 同時指定 token + branch-token）
      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.PAT_TOKEN }} # API 用
          branch-token: ${{ secrets.PAT_TOKEN }} # git push 用 ⭐⭐⭐
          branch: chore/update-docker-pulls-metrics
          delete-branch: true
          commit-message: "chore(metrics): update docker pull history"
          title: "chore(metrics): update docker pull history"
          body: |
            自動更新 Docker Pull 統計資料

            - 更新 metrics/docker-pulls.csv
            - 更新 metrics/docker-pulls-history.svg
          labels: automated,metrics
