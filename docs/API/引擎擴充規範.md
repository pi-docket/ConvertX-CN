# 引擎擴充規範 (Engine Extension Specification)

本文件定義了 ConvertX-CN 中新增轉換引擎的標準方式，確保 API 穩定性與可擴展性。

---

## 目錄

- [概述](#概述)
- [引擎 Schema 標準](#引擎-schema-標準)
- [擴充步驟](#擴充步驟)
- [範例實作](#範例實作)
- [API 整合](#api-整合)
- [最佳實踐](#最佳實踐)

---

## 概述

### 設計原則

1. **對外 API 不變**：新增引擎不需修改任何 API 端點定義
2. **自動探索**：引擎透過 `properties` 物件自動被系統發現
3. **格式優先**：使用者按格式選擇，系統自動選擇最佳引擎
4. **向下相容**：現有轉換流程不受新引擎影響

### 引擎類型

| 類型       | 說明           | 範例                               |
| ---------- | -------------- | ---------------------------------- |
| `image`    | 影像格式轉換   | ImageMagick, vips, resvg           |
| `vector`   | 向量圖形轉換   | Inkscape, potrace, vtracer         |
| `document` | 文件格式轉換   | LibreOffice, Pandoc                |
| `ebook`    | 電子書格式轉換 | Calibre                            |
| `media`    | 多媒體轉換     | FFmpeg                             |
| `data`     | 結構化資料轉換 | dasel                              |
| `ai`       | AI 驅動轉換    | MinerU, PDFMathTranslate, OCRmyPDF |
| `3d`       | 3D 模型轉換    | Assimp                             |
| `other`    | 其他類型       | -                                  |

---

## 引擎 Schema 標準

### Properties 結構

每個引擎必須導出一個 `properties` 物件，符合以下 TypeScript 介面：

```typescript
interface EngineProperties {
  from: {
    [category: string]: string[]; // 輸入格式列表
  };
  to: {
    [category: string]: string[]; // 輸出格式列表
  };
  outputMode?: "archive"; // 可選：輸出模式
  options?: {
    [category: string]: {
      [optionName: string]: {
        description: string;
        type: "string" | "number" | "boolean";
        default: string | number | boolean;
        enum?: (string | number)[]; // 可選：可選值列表
      };
    };
  };
}
```

### Convert 函數標準

```typescript
type ConvertFunction = (
  filePath: string, // 輸入檔案完整路徑
  fileType: string, // 輸入格式 (正規化後)
  convertTo: string, // 目標格式
  targetPath: string, // 輸出檔案路徑
  options?: unknown, // 可選參數
) => Promise<string>; // 回傳 "Done" 或錯誤訊息
```

---

## 擴充步驟

### 步驟 1：建立引擎檔案

在 `src/converters/` 目錄下建立新檔案：

```bash
src/converters/{engine-name}.ts
```

### 步驟 2：定義 Properties

```typescript
export const properties = {
  from: {
    documents: ["pdf", "docx"], // 支援的輸入格式
  },
  to: {
    documents: ["md", "txt"], // 支援的輸出格式
  },
};
```

### 步驟 3：實作 Convert 函數

```typescript
export function convert(
  filePath: string,
  fileType: string,
  convertTo: string,
  targetPath: string,
  options?: unknown,
): Promise<string> {
  return new Promise((resolve, reject) => {
    // 實作轉換邏輯
  });
}
```

### 步驟 4：註冊到 main.ts

在 `src/converters/main.ts` 中加入引擎：

```typescript
import { convert as convertMyEngine, properties as propertiesMyEngine } from "./myengine";

const properties = {
  // ... 現有引擎
  myEngine: {
    properties: propertiesMyEngine,
    converter: convertMyEngine,
  },
};
```

### 步驟 5：完成！

系統會自動：

- 在 `/api/v1/engines` 列出新引擎
- 在 `/api/v1/formats` 包含新支援的格式
- 在轉換時自動選擇合適的引擎

---

## 範例實作

### 範例 1：簡單 CLI 工具引擎 (mineru)

```typescript
// src/converters/mineru.ts

import { execFile } from "node:child_process";
import { existsSync } from "node:fs";

export const properties = {
  from: {
    documents: ["pdf"],
  },
  to: {
    documents: ["md", "json"],
  },
  options: {
    documents: {
      mode: {
        description: "解析模式",
        type: "string",
        default: "auto",
        enum: ["auto", "ocr", "txt"],
      },
    },
  },
};

export function convert(
  filePath: string,
  fileType: string,
  convertTo: string,
  targetPath: string,
  options?: { mode?: string },
): Promise<string> {
  const mode = options?.mode || "auto";

  return new Promise((resolve, reject) => {
    execFile("mineru", ["-i", filePath, "-o", targetPath, "-m", mode], (error, stdout, stderr) => {
      if (error) {
        reject(`MinerU error: ${stderr || error.message}`);
        return;
      }
      if (!existsSync(targetPath)) {
        reject("Output file not created");
        return;
      }
      resolve("Done");
    });
  });
}
```

### 範例 2：多模式引擎 (ocrflux)

```typescript
// src/converters/ocrflux.ts

export const properties = {
  from: {
    images: ["png", "jpg", "tiff", "pdf"],
  },
  to: {
    documents: ["txt", "json", "hocr"],
  },
  options: {
    images: {
      language: {
        description: "OCR 語言",
        type: "string",
        default: "eng+chi_tra",
      },
      dpi: {
        description: "解析度",
        type: "number",
        default: 300,
      },
      psm: {
        description: "頁面分割模式",
        type: "number",
        default: 3,
        enum: [0, 1, 3, 4, 6, 7, 8, 11, 12, 13],
      },
    },
  },
};

export function convert(
  filePath: string,
  fileType: string,
  convertTo: string,
  targetPath: string,
  options?: { language?: string; dpi?: number; psm?: number },
): Promise<string> {
  // 實作 OCR 邏輯
}
```

### 範例 3：遠端 API 引擎 (chandra)

```typescript
// src/converters/chandra.ts

export const properties = {
  from: {
    documents: ["pdf"],
  },
  to: {
    documents: ["pdf-translated"],
  },
  options: {
    documents: {
      targetLang: {
        description: "目標語言",
        type: "string",
        default: "zh-TW",
      },
      provider: {
        description: "翻譯提供者",
        type: "string",
        default: "google",
        enum: ["google", "deepl", "openai", "azure"],
      },
      apiKey: {
        description: "API 金鑰 (選填，可用環境變數)",
        type: "string",
        default: "",
      },
    },
  },
};

export async function convert(
  filePath: string,
  fileType: string,
  convertTo: string,
  targetPath: string,
  options?: { targetLang?: string; provider?: string; apiKey?: string },
): Promise<string> {
  // 呼叫遠端 API 進行翻譯
  const apiKey = options?.apiKey || process.env.CHANDRA_API_KEY;

  // ... 實作遠端 API 呼叫
}
```

### 範例 4：自訂引擎 (custom-engine)

```typescript
// src/converters/custom-engine.ts

export const properties = {
  from: {
    custom: ["myformat"],
  },
  to: {
    custom: ["pdf", "html"],
  },
  outputMode: "archive", // 輸出多個檔案時使用
};

export function convert(
  filePath: string,
  fileType: string,
  convertTo: string,
  targetPath: string,
  options?: unknown,
): Promise<string> {
  // 自訂轉換邏輯
}
```

---

## API 整合

### 引擎自動被 API 發現

一旦引擎在 `main.ts` 註冊，以下 API 會自動更新：

| API 端點                              | 變化             |
| ------------------------------------- | ---------------- |
| `GET /api/v1/engines`                 | 列出新引擎       |
| `GET /api/v1/engines/:id`             | 可查詢新引擎詳情 |
| `GET /api/v1/formats`                 | 包含新支援的格式 |
| `GET /api/v1/formats/:format/targets` | 包含新的轉換路徑 |
| `POST /api/v1/validate`               | 驗證新的轉換組合 |
| `POST /api/v1/convert`                | 支援新引擎轉換   |

### 指定引擎轉換

使用者可以在 API 呼叫時指定引擎：

```bash
curl -X POST http://localhost:3000/api/v1/convert \
  -F "file=@document.pdf" \
  -F "outputFormat=md" \
  -F "engine=MinerU"  # 明確指定引擎
```

若不指定引擎，系統會自動選擇第一個支援該格式的引擎。

### 查詢可用引擎

```bash
# 查詢所有引擎
curl http://localhost:3000/api/v1/engines

# 查詢特定引擎
curl http://localhost:3000/api/v1/engines/MinerU

# 查詢 PDF 可轉換的格式
curl http://localhost:3000/api/v1/formats/pdf/targets
```

---

## 最佳實踐

### 1. 錯誤處理

```typescript
export function convert(...): Promise<string> {
  return new Promise((resolve, reject) => {
    try {
      // 驗證輸入
      if (!existsSync(filePath)) {
        reject("Input file not found");
        return;
      }

      // 執行轉換
      execFile("tool", args, (error, stdout, stderr) => {
        if (error) {
          // 提供有意義的錯誤訊息
          reject(`Conversion failed: ${parseError(stderr)}`);
          return;
        }

        // 驗證輸出
        if (!existsSync(targetPath)) {
          reject("Output file was not created");
          return;
        }

        resolve("Done");
      });
    } catch (e) {
      reject(`Unexpected error: ${e}`);
    }
  });
}
```

### 2. 跨架構支援

```typescript
import os from "node:os";

const arch = os.arch();
const platform = os.platform();

// 檢查工具是否可用
function isToolAvailable(): boolean {
  if (arch === "arm64" && platform === "linux") {
    // ARM64 可能不支援某些工具
    return existsSync("/usr/local/bin/tool");
  }
  return true;
}

// 在 main.ts 中條件註冊
if (isToolAvailable()) {
  properties.myEngine = {
    properties: propertiesMyEngine,
    converter: convertMyEngine,
  };
}
```

### 3. 選項驗證

```typescript
interface MyEngineOptions {
  quality?: number;
  format?: string;
}

export function convert(
  filePath: string,
  fileType: string,
  convertTo: string,
  targetPath: string,
  options?: MyEngineOptions,
): Promise<string> {
  // 選項預設值
  const quality = Math.min(100, Math.max(1, options?.quality || 85));
  const format = options?.format || "auto";

  // ... 使用驗證後的選項
}
```

### 4. 日誌記錄

```typescript
export function convert(...): Promise<string> {
  console.log(`[MyEngine] Converting ${fileType} → ${convertTo}`);
  console.log(`[MyEngine] Input: ${filePath}`);
  console.log(`[MyEngine] Output: ${targetPath}`);

  return new Promise((resolve, reject) => {
    execFile("tool", args, (error, stdout, stderr) => {
      if (stdout) {
        console.log(`[MyEngine] stdout: ${stdout}`);
      }
      if (stderr) {
        console.error(`[MyEngine] stderr: ${stderr}`);
      }

      // ...
    });
  });
}
```

---

## 附錄：現有引擎分類

| 引擎名稱         | 類型     | 輸入格式              | 輸出格式              |
| ---------------- | -------- | --------------------- | --------------------- |
| inkscape         | vector   | svg, emf, wmf, pdf    | png, pdf, svg, eps    |
| libjxl           | image    | jxl, png, jpg         | jxl, png, jpg         |
| resvg            | vector   | svg                   | png                   |
| vips             | image    | 多種圖片格式          | 多種圖片格式          |
| libheif          | image    | heic, heif, avif      | png, jpg              |
| xelatex          | document | tex                   | pdf                   |
| calibre          | ebook    | epub, mobi, azw       | epub, mobi, pdf       |
| dasel            | data     | json, yaml, toml, xml | json, yaml, toml, xml |
| libreoffice      | document | doc, docx, xls, ppt   | pdf, odt, txt         |
| pandoc           | document | md, html, rst, docx   | md, html, pdf, docx   |
| imagemagick      | image    | 200+ 種格式           | 200+ 種格式           |
| graphicsmagick   | image    | 多種圖片格式          | 多種圖片格式          |
| ffmpeg           | media    | mp4, mkv, avi, mp3    | mp4, webm, mp3, wav   |
| potrace          | vector   | bmp, pbm              | svg, pdf, eps         |
| vtracer          | vector   | png, jpg, bmp         | svg                   |
| MinerU           | ai       | pdf                   | md, json              |
| PDFMathTranslate | ai       | pdf                   | pdf (翻譯後)          |
| BabelDOC         | ai       | pdf                   | pdf (翻譯後)          |
| OCRmyPDF         | ai       | pdf                   | pdf (OCR 後)          |
